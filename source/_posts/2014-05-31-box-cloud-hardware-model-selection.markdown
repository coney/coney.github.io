---
layout: post
title: "box cloud hardware model selection"
date: 2014-05-31 23:59:26 +0800
comments: true
categories:
---
近几年来云计算可谓是大红大紫, 什么东西只要跟云沾上点关系立刻就会变得高大上起来. 而我们要做的事情就是把这朵云塞进一个小箱子中.

我们的目标是做出一个便携式的可携带云环境, 它对外的展现形式是一个普通的手提箱. 仅需插入电源和网线-这种在任何企业中都能找到的两样东西, 客户便能通过手提箱内的ScaleWorks将应用快速的部署至云上, 并且体验ScaleWorks所提供的强大的云管理功能.

在制作原型之前, 我们基于手提箱云的特点, 对手提箱云的硬件选型总结出以下四个方向:
* 首先是尺寸小. 因为手提箱的容积并不大, 为了使手提箱的对外接口保持简单, 我们需要将电源, 存储, 网络等硬件都集成至箱内, 再加上散热通风的考虑, 内部的硬件尺寸都不能过大.
* 其次是性能高. 手提箱云需要对外提供IaaS服务, 虚拟化是基础. 同时客户可能会部署一些开销较大的系统或应用, 这些对硬件设备性能都有一定要求.
* 第三是功耗低. 手提箱不像电脑机箱一样经过散热通风优化, 功耗较大的硬件会提升手提箱的散热设计难度, 并且会增大电源适配器的体积.
* 最后成本要适中. 鱼和熊掌不可兼得, 体积小性能强的硬件价格肯定不会便宜, 甚至还需要通过厂家定制. 在我们产品的原型阶段, 我们会考虑优先选择性价较高的在售产品.

总结以上四个方向, 此次硬件选型的关键词就是: 尺寸, 性能, 功耗和成本. 后文中的硬件筛选比较时也是按照这四个维度进行的.

## 尺寸选型

尺寸选型主要针对主板, 处理器和内存等设备都固定在主板上, 主板的规格直接影响到手提箱内部的硬件设计布局. 下面是一个比较常见的手提箱结构示意图(图片来自某宝):

![suitcase](/images/2014/06/suitcase.jpg)

这个尺寸差不多能够容纳是两台重叠在一起的14寸笔记本电脑. 当然我们不会直接将笔记本电脑主板放入手提箱内, 因为笔记本的定制度太高, 包含了很多对我们没有意义的硬件, 提升了成本. 如果将手提箱和1U机架服务器对比, 手提箱在厚度方面有一定优势, 但是长度宽度要比1U的服务器小很多, 即使较小的服务器主板也会铺满整个空间. 所以我们目标集中在PC主板上.

PC主板并不是统一的尺寸, 但主板规格百花齐放的同时也会遵循一定的标准, 例如Standard ATX, ITX, Mini-ITX等, 下图是常见的几种主板规格:

![motherboard-size](/images/2014/06/motherboard-size.jpg)

其中家用机使用较多的是ATX和Micro-ATX这两种规格, 也就是常说的大板和小板. 这两种主板的尺寸分别是305 × 244 mm和244 × 244 mm, 跟手提箱的尺寸相比, 虽然可以勉强放入, 但是略显拥挤. 不过这两种规格的主板最大的问题在于它们的高度. ATX主板一般不集成CPU, 需要额外安装CPU及配套散热器(风扇等), 而非集成的散热器厚度大多在100mm以上, 这样的高度会导致我们无法合上手提箱.

排除ATX系列的主板后, 我们把目光移向更加小巧的ITX系列主板, ITX同样细分为多种规格:

![itx-size](/images/2014/06/itx-size.jpg)

图中的Mini-ITX多用于HTPC或NAS, 更小的Nano-ITX, Pico-ITX等则更多用于收款机, 排号机等设备. 这些主板除尺寸较小外, 还有一个突出的特点就是集成了CPU及散热器, 并将整体高度控制的很低. 常见的带有主动散热的Mini-ITX主板高度在45mm左右, 而Nano-ITX主板高度都控制在25mm一以下. 这个尺寸对于我们的手提箱已经足够小巧, 并且可以在100mm的厚度中重叠两块主板, 为其他硬件节省出更多的空间. 而与ATX主板相比, 裁减掉的一些额外接口(PCI, Sata等)也是我们这个产品用不到的. 从尺寸和功能上看, ITX主板是一个不错的候选项.

ITX系列主板已经算是x86主板中较小的一员, 如果还想继续减小尺寸, 那只好往嵌入式方向探索. 提到嵌入式, 很自然地能够想到近年来如日中天的arm设备, arm的优势集中在便携性和低功耗, 很符合我们对尺寸以及功耗的要求. 此次我们同样挑选了两款流行的arm开发板做为我们的候选硬件, 它们分别是Raspberry PI(树莓派)及Cubieboard2:

图

树莓派的尺寸是85.60 x 56 x 21 mm, Cubieboard2的尺寸是 100 x 60 x 22 mm, 这两款开发板的体积都十分小巧, 比一张信用卡大不了多少. 同时这两个开发板对电源的要求很低, 普通的手机充电器就能充当开发板的电源适配器. 如果能采用arm的开发板, 手提箱的体积还能做的更小.

根据上面的分析结果, 初步筛选出来的候选主板列表如下(Mobile-ITX市面很难买到, 故从候选列表中移除):

|型号|尺寸(mm)|
|----|-------|
|Mini-ITX| 170 x 170 x 45|
|Nano-ITX| 170 x 170 x 45|
|Pico-ITX| 170 x 170 x 45|
|Raspberry PI| 170 x 170 x 45|
|Cubieboard2| 170 x 170 x 45|

## 成本

上一轮的尺寸选型中, 我们挑出了5种类型的主板. 树莓派和Cubieboard2是具体的产品型号, 我们可以直接从淘宝查询到价格. 但ITX只是主板的规格标准, 并不是具体产品. 所以这一节将结合电商网站报价, 选择几款具有代表性的ITX主板, 进行成本分析.

目前较新款集成处理器的Mini-ITX主板主要有两类, 一类是基于Bay Trail的Celeron J1800处理器, 另一种是基于Ivy Bridge的Celeron 1037U处理器, 集成这两款处理器的主板价格相近, 我们各选择一款加入到候选列表中.

Nano-ITX更多用于工控机, 比较少有传统主板厂商产品, 我们选择了一款威盛官方的公板以及一块不知名小厂的同样集成Celeron 1037U的主板.

Pico-ITX方面选择的余地就更少了, 从淘宝上只能找到威盛官方的产品, 而且价格不菲, 我们选择了淘宝上热度较高的一款加入对比.

另外同arm开发板相比, ITX主板虽然集成了处理器, 但是需要额外购买内存及电源模块, 这些都需要计算到成本中. 下表是整理后各主板成本列表:

|品牌|规格|配置|主板售价|内存成本|电源成本|总价格|
|---|----|---|-------|------|-------|-----|
|华擎 D1800B-ITX|Mini-ITX|Celeron J1800/4G Ram|429|250|150|829|
|盈通 玲珑C1037U|Mini-ITX|Celeron 1037U/4G Ram|429|250|150|829|
|威盛 EPIA-N800-13|Nano-ITX|VIA U2250/2G Ram|1984|200|100|2284|
|未知厂商 Q1037U|Nano-ITX|Celeron 1037U/4G Ram|650|250|150|1050|
|威盛 EPIA-P910-10Q|Pico-ITX|VIA QuadCore E/4G Ram|2910|250|100|3260|
|RaspberryPI|Mod B 512MB REV2.0|Broadcom BCM2835/512M Ram|250|0|20|270|
|Cubieboard2|Cubieboard2|AllWinner A20/1G Ram|390|0|20|410|

Mini-ITX
根据上表的结果, 可以看出ITX系列的主板, 比Mini-ITX更小的主板多为定制的工控机主板, 淘宝上销售的并不多, 并且价格昂贵. 威盛出款的两块公板成本都在2000以上, 结合VIA自己的CPU, 性价比太低. 首先被排除掉.

ITX系列主板中, Mini-ITX因为广泛应用在HTPC, NAS等家用小设备上, 所以有不少PC主板厂商介入研发生产, 价格合理. 而Nano-ITX, Pico-ITX则多用于工控机定制, 很少直接在市面上直接出售. 而官方的公板价格太高, 并且集成的VIC处理器性能很差, 性价比极低. 首先我们排除掉的就是


其次是一款Celeron 1037U的Nano ITX主板, 这款主板比同样配置的Mini-ITX长宽均减少50mm, 但这块主板并不是正规厂商生产, 做工较差, 电源也不是标准接口, 省掉的50mm并不能弥补其带来的风险, 性价比同样不高, 同样也被排除掉.

x86方面比较现实的选择就是Mini-ITX, 因为NAS及HTPC的普及, 使得大量传统主板厂商介入Mini-ITX的研发生产, 降低了Mini-ITX主板的价格.

接下来是两款arm的开发板, 毫无疑问这两位又是成本比较环节的优胜者, 除了自身低廉的成本外, 集成内存及较低的功率, 使arm开发版在价格上有绝对的优势.

经过成本筛选, 候选列表里剩余两款Mini-ITX主板及两款arm开发板:
|Mini-ITX|华擎 D1800B-ITX|829|
|Mini-ITX|盈通 玲珑C1037U|829|
|Raspberry PI|Mod B 512MB REV2.0|270|
|Cubieboard2|Cubieboard2|410|

* 性能 *
对于手提箱云的用户来说, 他们可能更关注的是使用的体验, 即使再精致的硬件, 如果不能满足用户的需求, 那也产生不了任何价值. 下表是根据性能维度重新整理的候选硬件信息:
|型号|CPU|内存|网络|虚拟化支持|功率|
|Raspberry PI|BCM2835/700Mhz/1core/128K L2Cache|512M|100M|N/A|3.5W|
|Cubieboard2|Allwinner A20/1Ghz/2cores/256K L2Cache|1G(Cubietruck最大支持2G)|100M|GIC/IPA/Virtual Interrupt|5W(不含sata硬盘)|
|华擎 D1800B-ITX|Celeron J1800/2.4Ghz/2cores/1M L2Cache|最高8G DDR3@1333|1000M|vt-x|10W(CPU Max TDP)|
|盈通 玲珑C1037U|Celeron 1037U/1.8Ghz/2cores/2M L2Cache|最高8G DDR3@1600|1000M|vt-x/EPT|17W(CPU Max TDP)|
下面我们对这四种平台一一进行分析:
** 树莓派 **
树莓派上市时间较早, 使用的Broadcom BCM2835单核心处理器. 处理器主频不高并且二级缓存只有128KB, 512MB不可扩展的内存也是该开发板的硬伤. 虽然理论上可以通过qemu来启动一些guest操作系统, 但是稀缺的内存资源使得不少java或ruby应用即使在Host上都无法取得流畅体验. 此外没有专门的虚拟化支持, 将树莓派做为VM host显得不太实际.

** Cubieboard2 **
Cubieboard是一款国产arm开发板, 相对于其他开发板, 其特点就是性能强悍. 使用了全志A20 1G双核处理器, 1G DDR3内存(升级版的Cubietruck支持2G内存). 此外A20处理器包含若干虚拟化技术, Xen也在该芯片上做了一系列实验. 参照Xen的[Wiki](http://wiki.xen.org/wiki/Xen_ARM_with_Virtualization_Extensions/Allwinner), 我们在cubieboard上搭建起了XenServer, 并且安装了一个Ubuntu 13.04做为Guest OS用以测试VM Guest的性能. 下面是若干性能测试结果:

todo :性能测试结果

测试结果并不是很令人满意, 限于arm处理器的运算能力, 一些cpu密集型的操作耗时很长. 这个会体现在编译安装ruby gem或Java JIT编译时. 假设用户在Cubieboard上部署rails应用, 一个多小时以上的`bundle install`基本是不可接受的. 
此外如果使用arm处理器来运行Windows Guest的话, 需要通过qemu的方式来软件模拟x86指令, 这个体验是完全不能接受的. 一个爱好者曾经花了半个小时来等待Window Guest系统的启动, 根本无法想象如何利用这么缓慢的系统来serve一些应用.
虽然可以在cubieboard2上利用XenServer创建Guest OS, 但只能serve一些简单的静态页面或者共享存储. 对于稍重一些的应用便显得力不从心, 另外对于Windows Guest的支持也比较差. 而我们手提箱云作为一个通用的云平台, 并不想限制用户使用的操作系统或是应用场景. 所以Cubieboard2依旧不满足我们的需求.
至此两块arm架构的开发板全部被淘汰. 但是在arm处理器高速发展的今天, 提升了运算能力的arm芯片依旧保持着低功耗低成本等优点, 在未来很有潜力被广泛应用于各种云基础设施中.

** 华擎 D1800B-ITX　& 盈通 玲珑C1037U **
这两块集成了x86处理器的主板放在这里统一进行分析. 这两块主板除cpu的差异外, 其他硬件配置及售价几乎完全一样, 所以在这两块主板之间的选择其实主要也是对比处理器差异. 下面的链接是intel官方的对比结果:

http://ark.intel.com/compare/78866,71995

从对比结果可以看出, J1800仅在主频和功耗上具有一定优势. 但是现在已不是比拼主频的时代, 1037U高出的额外7W Max TDP也并没有带来太大的影响.
1037U基于Ivy Bridge, 也就是广泛应用于上一代i7,i5及至强E7的架构, 而J1800基于Bay Trail, 实际就是Atom处理器, 性能并非强项. 此外1037U拥有更大的缓存以及EPT支持, 更加适合作为VM host使用. 基于成本考虑, 我们没有购入两款主板进行实际新能比较, 而是直接选择`盈通 玲珑C1037U`作为我们最终的主板方案.
下面是对改主板的一些性能测试数据:

性能数据

* 功耗　*
经过尺寸, 成本及性能的筛选, 我们已经选定集成`Celeron 1037U`的Mini-ITX主板作为我们最终的主板方案. 所以本节功耗部分主要考虑是对应的电源模块选型.
 Mini-ITX使用的是主板标准的24pin电源接口, 兼容普通台式机的电源. 但是普通台式机电源体积巨大, 虽然输出功率足够带动多个Mini-ITX主板, 但是输出的24pin电源接口只有一套, 定制起来比较复杂同时价格也不便宜.
 
市面上体积较小的HTPC一般使用的是外接电源适配器加内置电源模块的方式. 外接电源适配器提供12V的直流输出, 而内置的电源模块则将12V 2pin输入接口转为主板支持的24pin输出接口. 电源适配器输出接口比较简单, 容易扩展, 所以如果电源适配器功率足够大的话, 我们可以做一些改动使多块主板可以共享一个电源适配器来节省空间并降低成本.

我们使用的主板会配备一条8G DDR3内存及一个16G U盘做为启动盘, 另外可能会搭载一块SSD用于NFS共享, 每套环境功率保守估算在40W左右. 在手提箱云原型中, 可能会配备多块主板来搭建多个VM Host, 用以演示VM Pool或ScaleWorks的管理功能. 所以我们选择了淘宝上功率较大的一款外置适配器(120W), 用以日后扩展多块主板.

根据主板的预估功耗, 我们电源的最终方案是采用单电源适配器, 多电源模块的方案, 每个主板使用独立的电源模块供电, 所有电源模块共享同一个电源适配器的输出.



********
存储及网络

我们希望将手提箱做为一个虚拟资源池, 而不是一个单独的虚拟机使用, 所以通过NFS等方式的共享存储要比本地存储更加适合我们的应用场景. 而且在这种场景下, 我们也不需要容量较大的硬盘作为VM Host的载体, 一个16G左右的U盘便可以充当Host的系统盘, 这样不但能显著降低成本, 还能极大减少体积和功耗, 方便我们设计手提箱的内部结构.

Host系统可以安装在硬盘上, 但是我们不能寄希望于客户现场有NAS, 我们依然需要一块空间相对较大的硬盘作为共享存储, 供手提箱内的各个虚拟机的Guest使用, 关于这块硬盘用法, 我们有以下两种方案:
 1. 将硬盘挂入手提箱内一台物理机, 并在硬盘上安装Host系统, 之后讲剩余空间作为共享存储
 2. 将硬盘挂入手提箱内一台物理机, 该物理机依旧使用U盘启动系统, 将所有硬盘空间作为共享存储

第一种方案会将这块硬盘同时作为Host的系统盘和Guest的共享存储. 优点是能够节省一块U盘, 但是会造成了Hosts之间架构的不对称, 同时使用硬盘的Host系统会依赖于这块硬盘, 增加未来存储扩容的复杂性. 经过讨论认为扩展性要比节约的少量成本更加重要. 最终我们选定第二种存储方案, 即每个物理机都使用U盘引导.

最终的存储方案示意图如下:

图

从上图可以看出, 不同物理机之间会使用共享网络存储, 同时Guest系统以及ScaleWorks管理端也需要接入客户的网络中去, 我们采购的主板内置了千兆网卡, 但是直接将这些网口通过网线接入客户环境会显得非常凌乱, 比较好的方式是在手提箱内管理各个物理机的网络, 对外仅暴露一个以太网接口, 最终成型的产品仅需插入一根网线及一根电源线便能够使用.
为了达到上面描述的效果, 手提箱内需要配备一台交换机. 鉴于箱内的物理机数量并不多, 且均支持千兆网络, 我们交换机的选择标准十分明确: 体积小, 速度快, 成本低. 桌面式的SOHO千兆交换机最适合我们的场景, 最终我们选择了一款便宜的5口家用小交换机.

* 总结 *

至此, 我们已经拥有整套手提箱云所需的虚拟化硬件环境, 下图包含了此次选型结果中所有的硬件以及其依赖关系:
 
图


后续:
手提箱云系统设计
手提箱云结构设计

