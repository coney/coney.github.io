---
layout: post
title: "手提箱云硬件方案选型"
date: 2014-05-31 23:59:26 +0800
comments: true
published: false
categories:
---
近几年来云计算可谓是大红大紫, 什么东西只要跟云沾上点关系立刻就会变得高大上起来. 而我们要做的事情就是把这朵高高在上的云塞进一个小箱子里.

我们的目标是做出一个便携式的可携带云环境, 它对外的展现形式是一个普通的手提箱. 仅需插入电源和网线-这种在任何企业中都能找到的两样东西, 客户便能通过手提箱内的ScaleWorks将应用快速部署至云上, 并且体验ScaleWorks所提供的强大的云管理功能.

在制作原型之前, 我们基于手提箱云的特点, 对手提箱云的硬件选型总结出以下四个方向:

* 首先要尺寸小. 因为手提箱的容积较小, 为了使手提箱的对外接口保持简单, 我们需要将电源, 存储, 网络等硬件都集成至箱内, 再加上散热通风的考虑, 内部的硬件尺寸都不能过大.
* 其次是性能高. 手提箱云需要对外提供IaaS服务, 虚拟化是基础. 同时客户可能会部署一些开销较大的系统或应用, 这些对硬件设备性能都有一定要求.
* 第三是功耗低. 手提箱并不像电脑机箱一样经过散热通风优化, 功耗较大的硬件会提升手提箱的散热设计的难度, 并且会增大电源适配器的体积.
* 最后是成本要适中. 鱼和熊掌不可兼得, 体积小性能强的硬件价格肯定不会便宜, 甚至还需要通过厂家定制. 在我们产品的原型阶段, 我们会考虑优先选择性价较高的在售产品.

总结以上四个方向, 此次硬件选型的关键词就是: 尺寸, 性能, 功耗以及成本. 后文中的硬件筛选比较时也是按照这四个维度进行的.

## 尺寸选型

尺寸选型主要针对主板, 处理器和内存等设备都固定在主板上, 主板的规格直接影响到手提箱内部的硬件设计布局. 下面是一个比较常见的手提箱结构示意图(图片来自某宝):

![suitcase](/images/2014/06/suitcase.jpg)

<!--more-->

这个尺寸差不多能够容纳是两台重叠在一起的14寸笔记本电脑. 当然我们不会直接将笔记本电脑主板放入手提箱内, 因为笔记本的定制度太高, 包含了很多对我们没有意义的硬件, 提升了成本. 如果将手提箱和1U机架服务器对比, 手提箱在厚度方面有一定优势, 但是长度宽度要比1U的服务器小很多, 即使较小的服务器主板也会铺满整个空间. 所以我们目标集中在PC主板上.

PC主板并不是统一的尺寸, 但主板规格百花齐放的同时也会遵循一定的标准, 例如Standard ATX, ITX, Mini-ITX等, 下图是常见的几种主板规格:

![motherboard-size](/images/2014/06/motherboard-size.jpg)

其中家用机使用较多的是ATX和Micro-ATX这两种规格, 也就是常说的大板和小板. 这两种主板的尺寸分别是305 × 244 mm和244 × 244 mm, 跟手提箱的尺寸相比, 虽然可以勉强放入, 但是略显拥挤. 不过这两种规格的主板最大的问题在于它们的高度. ATX主板一般不集成CPU, 需要额外安装CPU及配套散热器(风扇等), 而非集成的散热器厚度大多在100mm以上, 这样的高度会导致我们无法合上手提箱.

排除ATX系列的主板后, 我们把目光移向更加小巧的ITX系列主板, ITX同样细分为多种规格:

![itx-size](/images/2014/06/itx-size.jpg)

其中Mini-ITX多用于HTPC或NAS, 更小的Nano-ITX, Pico-ITX等则更多用于收款机, 排号机等设备. 这些主板除尺寸较小外, 还有一个突出的特点就是集成了CPU及散热器, 并将整体高度控制的很低. 常见的带有主动散热的Mini-ITX主板高度在45mm左右, 而Nano-ITX主板高度都控制在25mm一以下. 这个尺寸对于我们的手提箱已经足够小巧, 并且可以在100mm的厚度中重叠两块主板, 为其他硬件节省出更多的空间. 而与ATX主板相比, 裁减掉的一些额外接口(PCI, Sata等)也是我们这个产品用不到的. 从尺寸和功能上看, ITX主板是一个不错的候选项.

ITX系列主板已经算是x86主板中较小的一员, 如果还想继续减小尺寸, 那只好往嵌入式方向探索. 提到嵌入式, 很自然地能够想到近年来如日中天的arm设备, arm的优势集中在便携性和低功耗, 很符合我们对尺寸以及功耗的要求. 此次我们同样挑选了两款流行的arm开发板做为我们的候选硬件, 它们分别是Raspberry PI(树莓派)及Cubieboard2:

![raspi](/images/2014/06/raspi.png) ![cubieboard2](/images/2014/06/cb2.png) 

树莓派的尺寸是85.60 x 56 x 21 mm, Cubieboard2的尺寸是 100 x 60 x 22 mm, 这两款开发板的体积都十分小巧, 比一张信用卡大不了多少. 同时这两个开发板对电源的要求很低, 普通的手机充电器就能充当开发板的电源适配器. 如果能采用arm的开发板, 手提箱的体积还能做的更小.

根据上面的分析结果, 初步筛选出来的候选主板列表如下(Mobile-ITX市面很难买到, 故从候选列表中移除):

型号|尺寸(mm)
:--:|:-----:
Mini-ITX| 170 x 170 x 45
Nano-ITX| 120 x 120 x 25
Pico-ITX| 100 x 72 x 45
Raspberry PI| 85.6 x 56 x 21
Cubieboard2| 100 x 60 x 22
## 成本

我们挑出了5种类型的主板. 树莓派和Cubieboard2是具体的产品型号, 我们可以直接从淘宝查询到价格. 但ITX只是主板的规格标准, 并不是具体产品. 所以这一节将结合电商网站报价, 选择几款具有代表性的ITX主板, 进行成本分析.

目前较新款集成处理器的Mini-ITX主板主要有两类, 一类是基于Bay Trail的Celeron J1800处理器, 另一种是基于Ivy Bridge的Celeron 1037U处理器, 集成这两款处理器的主板价格相近, 我们各选择一款加入到候选列表中.

Nano-ITX更多用于工控机, 比较少有传统主板厂商产品, 我们选择了一款威盛官方的公板以及一块不知名小厂的同样集成Celeron 1037U的主板.

Pico-ITX方面选择的余地就更少了, 从淘宝上只能找到威盛官方的产品, 而且价格不菲, 我们选择了淘宝上热度较高的一款加入对比.

另外同arm开发板相比, ITX主板虽然集成了处理器, 但是需要额外购买内存及电源模块, 这些都需要计算到成本中. 下表是整理后各主板成本列表:

品牌|规格|配置|主板售价|内存成本|电源成本|总价格|
---|----|---|-------|------|-------|-----|
华擎 D1800B-ITX|Mini-ITX|Celeron J1800/4G Ram|429|250|150|829
盈通 玲珑C1037U|Mini-ITX|Celeron 1037U/4G Ram|429|250|150|829
威盛 EPIA-N800-13|Nano-ITX|VIA U2250/2G Ram|1984|200|100|2284
未知厂商 Q1037U|Nano-ITX|Celeron 1037U/4G Ram|650|250|150|1050
威盛 EPIA-P910-10Q|Pico-ITX|VIA QuadCore E/4G Ram|2910|250|100|3260
RaspberryPI|Mod B 512MB REV2.0|Broadcom BCM2835/512M Ram|250|0|20|270
Cubieboard2|Cubieboard2|AllWinner A20/1G Ram|390|0|20|410

Mini-ITX
根据上表的结果, 可以看出ITX系列的主板, 比Mini-ITX更小的主板多为定制的工控机主板, 淘宝上销售的并不多, 并且价格昂贵. 威盛出款的两块公板成本都在2000以上, 结合VIA自己的CPU, 性价比太低. 首先被排除掉.

ITX系列主板中, Mini-ITX因为广泛应用在HTPC, NAS等家用小设备上, 所以有不少PC主板厂商介入研发生产, 价格合理. 而Nano-ITX, Pico-ITX则多用于工控机定制, 很少直接在市面上直接出售. 而官方的公板价格太高, 并且集成的VIC处理器性能很差, 性价比极低. 首先我们排除掉的就是


其次是一款Celeron 1037U的Nano ITX主板, 这款主板比同样配置的Mini-ITX长宽均减少50mm, 但这块主板并不是正规厂商生产, 做工较差, 电源也不是标准接口, 省掉的50mm并不能弥补其带来的风险, 性价比同样不高, 同样也被排除掉.

x86方面比较合适的选择就是Mini-ITX, 因为NAS及HTPC的普及, 使得大量传统主板厂商介入Mini-ITX的研发生产, 降低了Mini-ITX主板的价格同时有保证了质量.

接下来是两款arm的开发板, 毫无疑问这两款开发板又是成本环节的优胜者, 集成内存及较低的电源要求, 使arm开发版在价格上有着绝对的优势.

成本筛选的结果中, 仅剩余两款Mini-ITX主板及两款arm开发板:
品牌|规格|价格
----|----|----
华擎 D1800B-ITX|Mini-ITX|829
盈通 玲珑C1037U|Mini-ITX|829
Raspberry PI|Mod B 512MB REV2.0|270
Cubieboard2|Cubieboard2|410

## 性能
对于手提箱云的用户来说, 他们更关注的是使用体验, 即使再精致的硬件, 满足不了用户的需求, 那也产生不了任何价值.
在进行性能对比之前, 我们整理出各平台与性能相关的一些硬件指标:

型号|CPU|内存|网络|虚拟化支持|功率
----|---|----|----|----------|----
Raspberry PI|BCM2835 700Mhz/1core/128K L2|512M|100M|N/A|3.5W
Cubieboard2|Allwinner A20 1Ghz/2cores/256K L2|1G(Cubietruck最大支持2G)|100M|GIC/IPA/Virtual Interrupt|5W(不含sata硬盘)
华擎 D1800B-ITX|Celeron J1800 2.4Ghz/2cores/1M L2|最高8G DDR3@1333|1000M|vt-x|10W(CPU Max TDP)
盈通 玲珑C1037U|Celeron 1037U 1.8Ghz/2cores/2M L2|最高8G DDR3@1600|1000M|vt-x/EPT|17W(CPU Max TDP)

<br/>

** 树莓派 **

树莓派上市时间较早, 使用的Broadcom BCM2835单核心处理器. 处理器主频不高并且二级缓存只有128KB, 512MB不可扩展的内存也是该开发板的硬伤. 虽然理论上可以通过qemu来启动一些guest操作系统, 但是稀缺的内存资源使得不少java或ruby应用直接运行在宿主机上都无法取得流畅的体验. 同时该芯片也没有硬件虚拟化支持, 将树莓派做为VM Host显得并不实际.

** Cubieboard2 **

Cubieboard是一款国产arm开发板, 相对于其他品种的开发板, 它的特点就是性能强悍. Cubieboard2使用AllWinner A20 1G双核处理器, 1G DDR3内存(Cubietruck支持2G内存). 此外A20芯片包含若干硬件虚拟化技术, 能对运行在其上的Guest系统提供一些性能提升. 

XenProject在该芯片上做了一些支持. 我们参照Xen的[Wiki](http://wiki.xen.org/wiki/Xen_ARM_with_Virtualization_Extensions/Allwinner), 我们在cubieboard上搭建起XenServer并安装了Ubuntu 14.04做为Guest, 同时部署了基于Java的`Thoughtworks GO`进行体验. 但是结果并不令人满意, 仅是启动Go Server就消耗了5分钟以上的时间. 

限于arm处理器的运算能力, 一些cpu密集型的操作耗时很长. 这点直接体现在安装ruby gem或Java JIT的编译过程中. 如果用户在Cubieboard上部署rails应用, 耗时一个小时以上的`bundle install`基本是不可接受的. 

另一个比较致命的问题是arm架构的处理器不能直接执行x86指令, 需要通过软件仿真. 它会导致Cubieboard在运行基于x86的Windows Guest系统时异常缓慢. 参考Android开发中用性能远优于arm的x86处理器运行arm模拟器时的体验, 不难想象用arm处理器来模拟Windows的运行速度. 曾有一位爱好者花了半个小时来等待Windows Guest系统的启动, 这种体验完全无法交付给客户使用.

虽然Cubieboard2可以安装XenServer并运行一些Linux虚拟机, 但它仅适合做一些文件共享或是简单的HTTP应用, 我们的手提箱云作为一个通用的云平台, 并不想限制用户使用的操作系统或是应用场景. Cubieboard2看起来同样不适用与我们的产品.

两块arm架构的开发板最终全部被淘汰. 在arm处理器高速发展的今天, 提升运算能力的arm芯片依旧保持着低功耗低成本等优点, 相信未来很有潜力被应用于一些云基础设施中.

** 华擎D1800B-ITX & 盈通玲珑C1037U **

因为这两款集成了x86处理器的主板除CPU差异外, 其他硬件配置及售价几乎完全一样, 所以在这里统一进行分析. 下面的链接是两款处理器的官方数据对比结果:

http://ark.intel.com/compare/78866,71995

根据官方数据, J1800仅在主频和功耗上具有一定优势. 但是现已不是比拼主频的时代, J1800基于`Bay Trail`, 实际是一款Atom处理器, 而1037U则基于`Ivy Bridge`, 也就是广泛应用于上一代i7, i5及至强E7的处理器架构, 性能远高于基于`Bay Trail`. 同时1037U拥有更大的二级缓存及EPT支持, 更加适合作为虚拟机宿主. 虽然1037U的最大热功耗比J1800高出7W, 但是这并不会对我们的电源选择以及散热方案带来多少影响.

基于成本考虑, 我们没有购入两款主板进行实际性能比较, 而是直接选择`盈通 玲珑C1037U`作为我们最终主板方案. 以下是对该主板的性能测试结果:

性能数据



## 功耗 & 电源

经过以上几个维度的筛选, 我们决定使用集成`Celeron 1037U`的Mini-ITX主板作为我们最终方案. 所以功耗部分主要考虑的是对电源模块的选型.

Mini-ITX使用标准的24pin主板电源接口, 兼容普通台式机电源. 但是台式机电源体积较大, 虽然功率足以带动多个Mini-ITX主板, 但输出的24pin电源接口只有一套, 修改定制较为复杂且价格也不便宜.
 
参考市面上现有的HTPC电源方案, 大多是外接电源适配器配合内置电源模块的方式. 外接电源适配器提供12V的直流输出, 内置的电源模块则将12V 2pin的输入转为主板支持的24pin输出接口. 电源适配器输出接口结构简单, 容易扩展, 所以电源适配器功率够大的话, 我们可以修改适配器使其驱动多个电源模块, 这样不但节省了空间, 还能降低整体成本.

我们计划为主板配备一条8G DDR3内存及一块16G U盘做为系统盘, 此外主板可能会搭载一块硬盘用于存储共享. 按照计划的配置每套环境功率保守估算在40W左右. 同时我们计划在手提箱中配备多套硬件环境来搭建虚拟资源池, 所以我们选择了一款功率较大的外置适配器(120W), 用以驱动多套硬件环境.

根据选择的电源适配器功率及每套硬件环境的功耗估算, 我们决定使用单适配器多电源模块的方式, 即每套主板对应一个电源模块, 所有电源模块通过统一的电源适配器供电.


## 存储及网络

在电源方案选型中曾提到手提箱云将提供一个虚拟资源池, 而不是一台简单的虚拟机, 共享存储比本地存储要更加适合于我们的场景. 在这种情况下, 宿主机并不需要太大的本地存储来启动Host系统, 一个16G左右的U盘便可以充当宿主机的系统盘. 这样不但能显著降低成本, 还能极大缩小体积并降低功耗, 有利于未来设计手提箱内部的部署结构.

我们计划将Guest系统放在共享的存储上, 但是我们并不能寄希望于客户的NAS, 我们依旧需要一块空间相对较大的硬盘作为内置的共享存储, 供手提箱内的各个虚拟机使用. 关于这块硬盘用法, 我们有以下两种方案:
 1. 将硬盘接入一台宿主机, 并在硬盘上安装宿主机系统, 之后将剩余空间作为共享存储
 2. 将硬盘接入一台宿主机, 但宿主机仍使用U盘启动系统, 将所有硬盘空间都作为共享存储

方案一会将硬盘同时作为宿主机系统盘及虚拟机的共享存储. 其优点是节省了一块U盘的开销, 但是会造成宿主机之间架构不对称, 使用硬盘启动的宿主机会依赖于这块硬盘, 增加了未来对存储扩容的难度. 经过讨论我们认为架构的扩展性比节约的少量成本更重要. 最终我们选择方案二, 使各个宿主机不依赖于这块硬盘而独立运行.

下图是基于我们存储方案的XenServer运行示意图:

![Hardware Dependency](/images/2014/06/storage.png)

上图中ScaleWorks运行在虚拟机中, 用以管理手提箱内的云环境. 手提箱云内的多个宿主机之间需要通过网络来支撑共享存储, 同时客户也需要通过网络来接入运行于箱内的虚拟机, 我们必须将宿主机接入到客户的网络环境中去. 宿主机主板内置了千兆网卡, 但是直接将这些网口通过网线接入客户环境会显得非常复杂凌乱. 所以我们决定在手提箱内部集成一部交换机来连通各个宿主机的网络, 对外仅暴露一个以太网口. 这样最终产品将仅需一根网线和一根电源线便能交付使用.

鉴于箱内的宿主机数量并不多, 且均为千兆网卡, 出于性能, 成本及尺寸的考虑, 桌面式SOHO千兆交换机最适合我们的场景, 最终我们选择了一款5口的家用千兆小交换机.

## 总结

至此, 我们已经拥有整套手提箱云所需的虚拟化硬件环境, 下图是此次选型所有的硬件及其依赖关系.
 
![Hardware Dependency](/images/2014/06/hw-dep.png)


后续:

手提箱云系统设计

手提箱云结构设计

